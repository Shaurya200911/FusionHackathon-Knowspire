{% extends "base.html" %}
{% load static %}

{% block head %}
<title>{{ skill.title }} ‚Äì KnowSpire</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root {
    --bg: #ffffff;
    --text: #000000;
    --card-bg: #f8f9fa;
    --accent: #6366f1;
    --sidebar-bg: #f8f9fa;
    --sidebar-text: #000000;
    --sidebar-hover: #e2e8f0;
  }
  [data-theme="dark"] {
    --bg: #0d1117;
    --text: #ffffff;
    --card-bg: #161b22;
    --accent: #a78bfa;
    --sidebar-bg: #1e293b;
    --sidebar-text: #ffffff;
    --sidebar-hover: #334155;
  }
  html, body, #theme-root {
    background-color: var(--bg) !important;
    color: var(--text) !important;
    transition: background 0.3s, color 0.3s;
  }
  .dashboard-layout {
    display: flex;
  }
  .sidebar {
    width: 250px;
    background-color: var(--sidebar-bg);
    padding: 20px;
    min-height: 100vh;
  }
  .sidebar-link {
    display: block;
    color: var(--sidebar-text);
    padding: 10px;
    margin-bottom: 10px;
    text-decoration: none;
    border-radius: 5px;
  }
  .sidebar-link:hover {
    background-color: var(--sidebar-hover);
  }
  .main-content {
    flex-grow: 1;
    padding: 40px;
    background: none;
    color: var(--text);
  }
  .theme-toggle {
    margin-top: 20px;
  }
  .alert-info {
    background: var(--card-bg) !important;
    color: var(--text) !important;
    border-color: var(--accent) !important;
  }
  .carousel-item { display: none; }
  .carousel-item.active { display: block; }
</style>
{% endblock %}

{% block body %}
<div id="theme-root" data-theme="light" class="dashboard-layout">
  <div class="sidebar">
    <div class="text-center mt-4">
      <img src="{% static 'assets/images/img_header_logo.png' %}" width="80" alt="Logo">
    </div>
    <a href="{% url 'dashboard' %}" class="sidebar-link">üè† Dashboard</a>
    <a href="{% url 'leaderboard' %}" class="sidebar-link">üèÜ Leaderboard</a>
    <a href="{% url 'skills' %}" class="sidebar-link active">üìò Skills</a>
    <a href="{% url 'logout' %}" class="sidebar-link" id="logout-link">üîì Logout</a>
    <button class="theme-toggle btn btn-outline-secondary w-100" id="theme-toggle-btn">üåô Toggle Theme</button>
  </div>
  <div class="main-content">
    <div class="container" id="session-container">
      <h2 class="mb-4">{{ skill.title }}</h2>

      {% if limit_reached %}
        <div class="alert alert-warning">You‚Äôve completed the full 25 hours for this skill. üéì</div>
      {% elif session_started %}
        <div class="mb-5">
          <h4>üìò Lessons</h4>
          <div class="carousel" id="lesson-carousel">
            {% for lesson in lessons %}
              <div class="carousel-item card my-2 {% if forloop.first %}active{% endif %}">
                <div class="card-body">{{ lesson }}</div>
              </div>
            {% endfor %}
            <div class="d-flex justify-content-between mt-2">
              <button class="btn btn-outline-primary" onclick="prevItem('lesson-carousel')">‚¨ÖÔ∏è</button>
              <button class="btn btn-outline-primary" onclick="nextItem('lesson-carousel')">‚û°Ô∏è</button>
            </div>
          </div>
        </div>

        <div class="mb-5">
          <h4>üß† Flashcards</h4>
          <form method="post">
            {% csrf_token %}
            <div class="row g-3">
              {% for card in flashcards %}
                <div class="col-md-4">
                  <div class="flashcard card shadow-sm" onclick="flipCard(this)">
                    <div class="card-body">
                      <div class="flashcard-front">{{ card.question }}</div>
                      <div class="flashcard-back" style="display:none;">{{ card.answer }}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <button type="submit" name="flashcard-submit" class="btn btn-success mt-3">I've completed all flashcards</button>
          </form>
        </div>

        <div class="mb-5">
          <h4>‚ùì Quizzes</h4>
          <form method="post">
            {% csrf_token %}
            <div class="quiz-list">
              {% for quiz in quizzes %}
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-2 fw-bold">{{ quiz.question }}</div>
                    {% for option in quiz.options %}
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="quiz-{{ forloop.counter0 }}" value="{{ option|slice:1|upper }}" id="quiz-{{ forloop.counter0 }}-{{ forloop.counter }}">
                        <label class="form-check-label" for="quiz-{{ forloop.counter0 }}-{{ forloop.counter }}">{{ option }}</label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <button type="submit" name="quiz-submit" class="btn btn-primary mt-3">Submit Answers</button>
          </form>
        </div>
      {% else %}
        <div class="alert alert-info">No content available for this skill. (Lessons, flashcards, and quizzes are not implemented in the current version.)</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Theme toggle
  const root = document.getElementById('theme-root');
  const toggleBtn = document.getElementById('theme-toggle-btn');
  const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  root.setAttribute('data-theme', savedTheme);
  toggleBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  function setTheme(next) {
    root.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    toggleBtn.textContent = next === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  }
  toggleBtn.addEventListener('click', () => {
    const current = root.getAttribute('data-theme');
    const next = current === 'light' ? 'dark' : 'light';
    setTheme(next);
  });
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    const systemTheme = e.matches ? 'dark' : 'light';
    if (!localStorage.getItem('theme')) setTheme(systemTheme);
  });

  document.getElementById('logout-link').addEventListener('click', function(e) {
    // default logout
  });

  function nextItem(id) {
    const items = document.querySelectorAll(`#${id} .carousel-item`);
    const index = [...items].findIndex(i => i.classList.contains('active'));
    items[index].classList.remove('active');
    items[(index + 1) % items.length].classList.add('active');
  }

  function prevItem(id) {
    const items = document.querySelectorAll(`#${id} .carousel-item`);
    const index = [...items].findIndex(i => i.classList.contains('active'));
    items[index].classList.remove('active');
    items[(index - 1 + items.length) % items.length].classList.add('active');
  }

  function flipCard(card) {
    const front = card.querySelector('.flashcard-front');
    const back = card.querySelector('.flashcard-back');
    if (front.style.display !== 'none') {
      front.style.display = 'none';
      back.style.display = 'block';
    } else {
      front.style.display = 'block';
      back.style.display = 'none';
    }
  }
</script>
{% endblock %}
