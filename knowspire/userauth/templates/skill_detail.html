{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>{{ skill.title }} – Daily Session</title>
<style>
  :root {
    --card-bg: #ffffff;
    --text: #1f2937;
    --border: #e0e7ff;
    --accent: #7c3aed;
    --correct: #22c55e;
    --wrong: #ef4444;
  }

  [data-theme="dark"] {
    --card-bg: #1e293b;
    --text: #f3f4f6;
    --border: #475569;
    --accent: #a78bfa;
    --correct: #4ade80;
    --wrong: #f87171;
  }

  .session-wrapper {
    max-width: 760px;
    margin: 40px auto;
    padding: 20px;
  }

  .flashcard {
    background: var(--card-bg);
    border: 2px solid var(--border);
    padding: 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s;
  }

  .flashcard:hover {
    transform: scale(1.02);
  }

  .flashcard.flipped .front {
    display: none;
  }

  .flashcard.flipped .back {
    display: block;
  }

  .flashcard .front, .flashcard .back {
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  .flashcard .back {
    display: none;
    color: var(--accent);
  }

  .quiz-block {
    background: var(--card-bg);
    border: 2px solid var(--border);
    padding: 24px;
    border-radius: 16px;
  }

  .quiz-block h3 {
    margin-bottom: 16px;
    color: var(--text);
  }

  .quiz-option {
    margin: 12px 0;
  }

  .quiz-option input {
    margin-right: 10px;
  }

  .result-correct { color: var(--correct); font-weight: bold; }
  .result-wrong { color: var(--wrong); font-weight: bold; }

  .progress-bar {
    margin-top: 30px;
    background: var(--border);
    height: 12px;
    border-radius: 8px;
    overflow: hidden;
  }

  .progress-fill {
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    height: 100%;
    width: {{ user_skill.progress_pct }}%;
  }

  .xp-label {
    margin-top: 10px;
    font-size: 14px;
    color: var(--accent);
    font-weight: 600;
  }

  .btn-submit {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
</style>
{% endblock %}

{% block body %}
<div class="session-wrapper" id="theme-root" data-theme="light">
  <h1>{{ skill.title }} – Today's Session</h1>

  <!-- Flashcard Section -->
  <div class="flashcard" id="flashcard">
    <div class="front">{{ flashcard.front_text }}</div>
    <div class="back">{{ flashcard.back_text }}</div>
  </div>

  <!-- Quiz Section -->
  <div class="quiz-block">
    <h3>{{ quiz.question_text }}</h3>
    <form id="quiz-form" method="POST" action="{% url 'submit_quiz' quiz.id %}">
      {% csrf_token %}
      {% for option in [quiz.option_1, quiz.option_2, quiz.option_3, quiz.option_4] %}
        <div class="quiz-option">
          <label>
            <input type="radio" name="answer" value="{{ option }}" required>
            {{ option }}
          </label>
        </div>
      {% endfor %}
      <button type="submit" class="btn-submit">Submit</button>
    </form>
    <div id="quiz-result"></div>
  </div>

  <!-- Progress + XP -->
  <div class="progress-bar">
    <div class="progress-fill"></div>
  </div>
  <div class="xp-label">
    Current Progress: {{ user_skill.progress_pct }}% – XP: {{ user_skill.xp_earned }}
  </div>
</div>

<script>
  // Flashcard flip
  document.getElementById("flashcard").addEventListener("click", function () {
    this.classList.toggle("flipped");
  });

  // Quiz handler
  document.getElementById("quiz-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const response = await fetch(form.action, {
      method: "POST",
      headers: {
        "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    });
    const data = await response.json();
    const result = document.getElementById("quiz-result");

    if (data.status === "error") {
      result.innerHTML = `<div class="result-wrong">${data.message}</div>`;
    } else {
      if (data.is_correct) {
        result.innerHTML = `<div class="result-correct">✅ Correct! +${data.xp_awarded} XP</div>`;
      } else {
        result.innerHTML = `<div class="result-wrong">❌ Wrong! Correct answer: ${data.correct_answer}</div>`;
      }
    }

    form.querySelector("button").disabled = true;
  });
</script>
{% endblock %}
